{#- TODO: Replace with dynamic IPs #}
# Generated by SaltStack
{% set v6_subnet = "%x" | format(512 + ( network_id / 2 ) | int) -%}
{% set v6_local =  "%x" | format(network_id + 1 ) -%}
{% set v6_remote = "%x" | format(network_id ) -%}


router id 172.20.{{ (network_id / 2) | int }}.1;

define FREIFUNK = 1023;
filter default_in {
    if net ~ [
        ::/0
    ] then accept;
    reject;
};

protocol kernel {
    kernel table FREIFUNK;
    scan time 60;
    merge paths yes;
    import all;
    export filter default_in; # Actually insert routes into the kernel routing table
}

protocol device {
    scan time 60;
}

filter vpn_prefixes {
    if net ~ [
        2001:608:a01:200::/56{64,64}
    ] then accept;
    reject;
}
{# Note: 512 = 2 *16^2 + 0 *16^1 + 0*16^0 #}
protocol static {
    route 2001:608:a01:{{ v6_subnet }}::/64 via 2001:608:a01:{{ v6_subnet }}::1;
    export all;
}

template bgp ebgp {
    import filter default_in;
    export filter vpn_prefixes;
    enable route refresh yes;
    graceful restart yes;
}

protocol bgp vpn01 from ebgp {
    local 2001:608:a01:fffe::{{ v6_local }} as {{ 64512 + network_id }};
    source address 2001:608:a01:fffe::{{ v6_local }};
    neighbor 2001:608:a01:fffe::{{ v6_remote }} as 65132;
    import all;
    export all;
}

protocol bgp vpn02 from ebgp {
    local 2001:608:a01:fffd::{{ v6_local }} as {{ 64512 + network_id }};
    source address 2001:608:a01:fffd::{{ v6_local }};
    neighbor 2001:608:a01:fffd::{{ v6_remote }} as 65132;
    import all;
    export all;
}

protocol radv {
    # ONLY advertise prefix, IF default route is available
    import all;
    export all;
    trigger ::/0;

    rdnss 2001:608:a01:{{ v6_subnet }}::1;
    interface "<CHANGEME>" {
        default lifetime 600 sensitive yes;

        prefix 2001:608:a01:{{ v6_subnet }}::/64 {
            preferred lifetime 3600;
        };
    };
}