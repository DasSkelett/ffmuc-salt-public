{#- TODO: Replace with dynamic IPs #}
# Generated by SaltStack

router id 172.20.{{ (network_id / 2) | int }}.1;

define FREIFUNK 1023;
filter default_in {
    if net ~ [
        0.0.0.0/0
    ] then accept;
    reject;
};

protocol kernel {
    kernel table FREIFUNK;
    scan time 60;
    merge paths yes;
    import all;
    export filter default_in; # Actually insert routes into the kernel routing table
}

protocol device {
    scan time 60;
}

filter vpn_prefixes {
    if net ~ [
        172.20.0.0.15/{24,24}
    ] then accept;
    reject;
}

protocol static {
    route 172.20.{{ (network_id / 2) | int }}.0/24 via 172.20.{{ (network_id / 2) | int }}.1;
    export all;
}

template bgp ebgp {
    import filter default_in;
    export filter vpn_prefixes;
    enable route refresh yes;
    graceful restart yes;
}

protocol bgp vpn01 from ebgp {
    local 172.17.0.{{ network_id + 1 }} as {{ 64512 + network_id }};
    neighbor 172.17.0.{{ network_id }} as 65132;
    import all;
    export all;
}

protocol bgp vpn02 from ebgp {
    local 172.18.0.{{ network_id + 1 }} as {{ 64512 + network_id }};
    neighbor 172.18.0.{{ network_id }} as 65132;
    import all;
    export all;
}