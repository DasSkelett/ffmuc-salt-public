{%- set priv_key = salt.file.read('/etc/wireguard/keys/server-priv.key') %}
{%- set pub_key = salt.file.read('/etc/wireguard/keys/client-' ~ client_name ~  '-pub.key') %}
{%- set client_net_v4 = salt['site_prefixes.get_site_prefixes'](
    salt['pillar.get']('netbox:config_context:netbox:api_url'),
    salt['pillar.get']('netbox:config_context:wireguard:netbox_token'),
    salt['pillar.get']('netbox:config_context:wireguard:client_net_v4')
) %}
{%- set client_net_v6 = salt['site_prefixes.get_site_prefixes'](
    salt['pillar.get']('netbox:config_context:netbox:api_url'),
    salt['pillar.get']('netbox:config_context:wireguard:netbox_token'),
    salt['pillar.get']('netbox:config_context:wireguard:client_net_v6')
) %}
{%- set port = 51820 + network_id  -%}

# Generated by Saltstack 

[Interface]
PrivateKey = {{ priv_key }}
ListenPort = {{ port }}

[Peer]
PublicKey = {{ pub_key }}
AllowedIPs = {{ interfaces[interface]['ipaddresses'][0]['address'] }}, {%- for net in client_net_v4 -%}{%- if client_name in net -%}{{ client_net_v4[net] }},{%- endif -%}{%- endfor -%} {{ interfaces[interface]['ipaddresses'][1]['address'] }}{%- for net in client_net_v6 -%}{%- if client_name in net -%},{{ client_net_v6[net] }}{%- endif -%}{%- endfor -%}
