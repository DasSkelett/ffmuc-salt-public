#
# {{ node_id }}
#
{%- set roles = salt['mine.get'](node_id,'minion_roles')[node_id] %}
{%- set role = salt['mine.get'](node_id,'minion_role')[node_id] %}
{%- set device_role = salt['mine.get'](node_id,'minion_device_role')[node_id] %}
{%- set sites = salt['pillar.get']('netbox:config_context:sites') %}
{%- set address = salt['mine.get'](node_id,'minion_address', tgt_type='glob')[node_id] %}
{%- set address6 = salt['mine.get'](node_id,'minion_address6', tgt_type='glob')[node_id] %}
{%- set icinga_address = salt['mine.get'](grains['id'],'minion_address', tgt_type='glob')[grains['id']] %}
{%- set icinga_address6 = salt['mine.get'](grains['id'],'minion_address6', tgt_type='glob')[grains['id']] %}

{% if 'mine_interval' not in role %}
{% do roles.append(role) %}
{% elif 'mine_interval' not in device_role %}
{% do roles.append(device_role) %}
{% endif %}

{%- if 'icinga2_server' not in roles %}
object Endpoint "{{ node_id }}" {
        host = "{{ node_id }}"
}

object Zone "{{ node_id }}" {
	endpoints = [ "{{ node_id }}" ]
	parent = "master"
}
{%- endif %}

object Host "{{ node_id }}" {
	import "generic-host"

	display_name = "{{ node_id }}"
	{% if 'mine_interval' not in address and'mine_interval' not in icinga_address %}
	address = "{{ address | regex_replace('/\d+$','') }}"
	{% endif %}
	{% if 'mine_interval' not in address6 and 'mine_interval' not in icinga_address6 %}
	address6 = "{{ address6 | regex_replace('/\d+$','') }}"
	{% endif %}
        check_command = "hostalive"

	vars.os = "Linux"

	vars.roles = [
	{%- for role in roles|sort %}
		"{{ role }}",
	{%- endfor %}
	]

	vars.sites = [
	{%- for site in sites|sort %}
		"{{ site }}",
	{%- endfor %}
	]
	vars.disks["disk /"] = {
	      disk_partitions = "/"
	}

	{% if 'backupserver' in roles %}
	vars.disks["disk /srv"] = {
	      disk_partitions = "/srv"
	}
	{% elif 'buildserver' in roles %}
	vars.disks["disk /build"] = {
	      disk_partitions = "/build"
	}
	{% endif %}
}					

