{% if salt['pillar.get']('netbox:role:name') %}
{%- set role = salt['pillar.get']('netbox:role:name') %}
{% else %}
{%- set role = salt['pillar.get']('netbox:device_role:name') %}
{% endif %}

{% set snmp_addresses = salt['pillar.get']('netbox:services:snmp:ipaddresses') %}

{%- set ro_community = salt['pillar.get']('netbox:services:snmp:custom_fields:api_token') %}
{%- set sys_location = salt['pillar.get']('netbox:site:name') %}
{%- set address = salt['pillar.get']('netbox:primary_ip4:address') | regex_replace('/\d+$','') %}
{%- set address6 = salt['pillar.get']('netbox:primary_ip6:address') | regex_replace('/\d+$','') %}

#
# /etc/snmp/snmpd.conf (Salt managed)
#

# Listen for connections from the local system

# Listen for connections on Loopback-IPs
{% if address and address6 %}
agentAddress  udp:127.0.0.1:161
agentAddress  udp6:[::1]:161
agentAddress  udp:{{ address }}:161
agentAddress  udp6:[{{ address6 }}]:161
{% endif %}
rocommunity   {{ ro_community }} 127.0.0.1
rocommunity6 {{ ro_community }}	::1

{% for snmp_address in snmp_addresses %}
{%- if snmp_address['family'] == 4 %}
rocommunity   {{ ro_community }} {{ snmp_address['address'] | regex_replace('/\d+$','') }}
{%- elif snmp_address['family'] == 6 %}
rocommunity6 {{ ro_community }}	{{ snmp_address['address'] | regex_replace('/\d+$','') }}
{%- endif %}
{% endfor %}

com2sec notConfigUser  default  {{ ro_community }}
group   notConfigGroup v1       notConfigUser
group   notConfigGroup v2c      notConfigUser
view    systemview    included   .1.3.6.1.2.1.1
view    systemview    included   .1.3.6.1.2.1.25.1.1
access  notConfigGroup ""      any       noauth    exact  systemview none none

sysLocation    {{ sys_location }}
sysContact     hilfe@ffmuc.net
sysServices    72

#
# Network interfaces
#

{%- for interface in salt['grains.get']('ip_interfaces') %}
{%- if 'vlan' in interface or 'vrf_external' in interface or 'br0' in interface or 'eth0' in interface or 'enp' in interface %}
interface {{ interface }} 6 1000000000
{%- else %}
interface {{ interface }} 6 100000000
{%- endif %}
{%- endfor %}
{%- set ovpn_networks = [] %}
{%- for netname, network in salt['pillar.get']('ovpn', {}).items () if grains['id'] in network %}
  {%- do ovpn_networks.append (netname) %}
{%- endfor %}
{%- for netname in ovpn_networks|sort %}
  {%- set network = salt['pillar.get']('ovpn:' ~ netname) %}
  {%- set network_config = network.get ('config') %}
  {%- set host_stanza = network.get (grains['id']) %}
  {%- set host_config = host_stanza.get ('config', {}) %}
  {%- set interface = host_config.get ('interface', network_config.get ('interface')) %}
  {%- if loop.first %}
# OpenVPN interfaces
  {%- endif %}
interface	{{ interface }}	6	100000000
{%- endfor %}

#

