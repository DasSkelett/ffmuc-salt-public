pki:
  ca: /etc/nebula/ca.crt
  cert: /etc/nebula/{{ grains.fqdn }}.crt
  key: /etc/nebula/{{ grains.fqdn }}.key

static_host_map:
  "{{ salt['pillar.get']('netbox:config_context:nebula:lighthouse:private_ip','192.168.110.1') }}":
    - "{{ salt['pillar.get']('netbox:config_context:nebula:lighthouse:public_addr','127.0.0.1:1234') }}"

lighthouse:
  am_lighthouse: false
  interval: 60
  hosts:
    - {{ salt['pillar.get']('netbox:config_context:nebula:lighthouse:private_ip','192.168.110.1') }}

listen:
  host: 0.0.0.0
  port: 4242

punchy:
  punch: true

local_range: "{{ salt['pillar.get']('netbox:config_context:nebula:local_range','192.168.110.1') }}"

tun:
  dev: nebula1
  # Toggles forwarding of local broadcast packets, the address of which depends on the ip/mask encoded in pki.cert
  drop_local_broadcast: true
  # Toggles forwarding of multicast packets
  drop_multicast: true
  tx_queue: 500
  mtu: 1300

logging:
  level: info
  format: text

firewall:
  conntrack:
    tcp_timeout: 120h
    udp_timeout: 3m
    default_timeout: 10m
    max_connections: 100000

  outbound:
  - port: any
    proto: any
    host: any

  inbound:
  - port: any
    proto: icmp
    host: any
{% if "graylog" in salt["pillar.get"]("netbox:config_context:docker") -%}
    # Allow pushing to graylog via filebeat
  - port: 5044
    proto: tcp
    host: any
{% endif -%}
{% if "salt_master" in salt["pillar.get"]("netbox:config_context:roles") -%}
    # Allow salt access for any host in the network
  - port: 4505-4506
    proto: tcp
    host: any
{% endif -%}
{% if "stats.in.ffmuc.net" == grains["id"] -%}
  # Allow stats
  - port: 8086
    proto: tcp
    groups:
      - jvb
  # Allow stats
  - port: 8086
    proto: tcp
    groups:
      - jibri
  # Allow stats
  - port: 8086
    proto: tcp
    host: jvb0.int.meet.ffmuc.net
{% endif %}