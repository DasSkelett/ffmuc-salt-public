#!/bin/bash

for i in `ip -br a | grep vx- | awk '{print $1}' | cut -d\- -f2`;
do
    logger -t bridge-fdb-settings "adding fdb entries for $i"
{%- for node,bla in salt['mine.get']('netbox:role:name:nextgen-gateway', 'minion_id', tgt_type='pillar').items() | sort %}
{%- if grains['id'] not in node %}
{%- set wireguard_public_key = salt['mine.get'](node,'minion_wireguard_public', tgt_type='glob')[node]  %}
{%- if wireguard_public_key %}
{%- set link_local = salt['wireguard_v6.generate'](wireguard_public_key) %}
    # Set FDB to connect to {{ node }}
    bridge fdb append 00:00:00:00:00:00 dev vx-$i dst {{ link_local }} via wg-$i
{%- endif %}{# wireguard_public_key #}
{%- endif %}{# grains['id'] not in node #}
{%- endfor %}{# node #}
done
